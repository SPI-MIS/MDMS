# 投票系統 - 系統架構概覽

## 整體架構圖

```
┌─────────────────────────────────────────────────────────────────────┐
│                         前端應用 (Vue 3)                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │
│  │  員工投票前台    │  │  主辦者後台      │  │  IT管理平台      │  │
│  │  (EmployeeVote)  │  │  (VoteAdmin)     │  │  (ITManagement)  │  │
│  ├──────────────────┤  ├──────────────────┤  ├──────────────────┤  │
│  │• 投票列表        │  │• 投票管理        │  │• 統計監控        │  │
│  │• 投票卡片        │  │• 建立/編輯投票   │  │• 用戶管理        │  │
│  │• 投票對話框      │  │• 結果查看        │  │• 日誌查詢        │  │
│  │• 結果顯示        │  │• 統計匯出        │  │• 系統設定        │  │
│  │• 防重複機制      │  │• 詳情檢視        │  │• 資料分析        │  │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘  │
│                                                                       │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │            共享組件 (Components/vote)                           │ │
│  ├────────────────────────────────────────────────────────────────┤ │
│  │ VoteCard │ VoteDialog │ VoteResultsDialog │ VoteDetailDialog  │ │
│  │ VoteStatisticsDialog                                           │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                       │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │          狀態管理 (Pinia - stores/vote.js)                     │ │
│  ├────────────────────────────────────────────────────────────────┤ │
│  │ • 投票列表狀態        • 提交投票方法                           │ │
│  │ • 當前投票狀態        • 檢查投票狀態                           │ │
│  │ • 載入狀態            • 獲取投票結果                           │ │
│  │ • 錯誤狀態            • CRUD 操作                              │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                       │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │          i18n (国际化 - locales/zh-tw.json)                    │ │
│  ├────────────────────────────────────────────────────────────────┤ │
│  │ • 投票相關翻譯        • UI 標籤翻譯                            │ │
│  │ • 驗證消息翻譯        • 系統消息翻譯                           │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                       │
└─────────────────────────────────────────────────────────────────────┘
                              ↓ HTTP/API
┌─────────────────────────────────────────────────────────────────────┐
│                      後端 API (Express.js)                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │              API 路由 (routes/votes.js)                        │ │
│  ├────────────────────────────────────────────────────────────────┤ │
│  │ GET  /api/votes                    - 查詢投票列表             │ │
│  │ GET  /api/votes/:voteId            - 獲取投票詳情             │ │
│  │ POST /api/votes                    - 建立投票                 │ │
│  │ PUT  /api/votes/:voteId            - 更新投票                 │ │
│  │ DELETE /api/votes/:voteId          - 刪除投票                 │ │
│  │ POST /api/votes/submit             - 提交投票 (員工)          │ │
│  │ GET  /api/votes/:voteId/check-voted- 檢查投票狀態             │ │
│  │ GET  /api/votes/:voteId/results    - 獲取投票結果             │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                       │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                業務邏輯層 (在路由中實現)                        │ │
│  ├────────────────────────────────────────────────────────────────┤ │
│  │ • 投票驗證          • 防重複投票檢查                           │ │
│  │ • 投票計數更新      • 統計計算                                 │ │
│  │ • 權限檢查          • 日誌記錄                                 │ │
│  │ • 時間驗證          • 資料轉換                                 │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                       │
└─────────────────────────────────────────────────────────────────────┘
                              ↓ MSSQL
┌─────────────────────────────────────────────────────────────────────┐
│                   資料庫 (SQL Server)                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌─────────────────┬──────────────────┬──────────────────┐          │
│  │   Votes         │  VoteOptions     │  VoteParticipants│          │
│  │  (投票主表)     │  (投票選項)      │  (參與者-防重複) │          │
│  ├─────────────────┼──────────────────┼──────────────────┤          │
│  │ PK: voteId      │ PK: optionId     │ PK: participantId│          │
│  │ activityName    │ FK: voteId ───┐  │ FK: voteId ────┐ │          │
│  │ voteTitle       │ optionText     │  │ userId         │ │          │
│  │ voteDescription │ optionOrder    │  │ votedAt        │ │          │
│  │ voteType        │ voteCount      │  │ UNIQUE(voteId, │ │          │
│  │ allowMultiple   └──────────────────┤ userId) ◄──────┘ │          │
│  │ startTime                           │                  │          │
│  │ endTime         ┌──────────────────┼─────────────┐   │          │
│  │ allowAnonymous  │  VoteRecords     │ VoteLogs    │   │          │
│  │ resultsPublic   │  (投票記錄)      │ (系統日誌)  │   │          │
│  │ voteStatus      ├──────────────────┼─────────────┤   │          │
│  │ createdBy       │ PK: voteRecordId │ PK: logId   │   │          │
│  │ createdAt       │ FK: voteId ┐     │ FK: voteId  │   │          │
│  │ updatedBy       │ FK: optionId ──┐ │ action      │   │          │
│  │ updatedAt       │ userId (nullable)│ userId      │   │          │
│  │                 │ votedAt         │ details     │   │          │
│  │                 │                 │ createdAt   │   │          │
│  │                 └──────────────────┴─────────────┘   │          │
│  │                                                       │          │
│  │  ┌──────────────────────────────────────────────┐   │          │
│  │  │    VoteSystemSettings (系統設定)            │   │          │
│  │  ├──────────────────────────────────────────────┤   │          │
│  │  │ settingId  │ settingName  │ settingValue  │   │          │
│  │  └──────────────────────────────────────────────┘   │          │
│  │                                                       │          │
│  └───────────────────────────────────────────────────────┘          │
│                                                                       │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │ 資料庫視圖 (Views)                                             │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │ • vw_VoteStatistics      - 投票統計檢視                       │  │
│  │ • vw_UserVoteStatistics  - 用戶投票統計檢視                   │  │
│  │ • vw_OptionStatistics    - 選項統計檢視                       │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                       │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │ 索引 (Indexes)                                                 │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │ • IX_Votes_Status              • IX_VoteParticipants_VoteId  │  │
│  │ • IX_Votes_CreatedAt           • IX_VoteParticipants_UserId  │  │
│  │ • IX_VoteOptions_VoteId        • IX_VoteRecords_VoteId       │  │
│  │ • IX_VoteRecords_UserId        • IX_VoteLogs_CreatedAt       │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                       │
└─────────────────────────────────────────────────────────────────────┘
```

## 核心流程

### 1. 投票建立流程
```
主辦者填寫表單
      ↓
前端驗證 (Vuetify rules)
      ↓
調用 API: POST /api/votes
      ↓
後端驗證必填字段
      ↓
插入 Votes 表
      ↓
插入 VoteOptions 表
      ↓
插入 VoteLogs 表 (CREATE)
      ↓
返回 voteId
      ↓
前端儲存 Pinia 狀態
      ↓
投票建立完成（狀態：Draft）
```

### 2. 員工投票流程
```
員工進入投票頁面
      ↓
載入投票列表: GET /api/votes?state=Active
      ↓
檢查用戶投票狀態: GET /api/votes/:voteId/check-voted?userId=xxx
      ↓
未投票 → 顯示投票按鈕 / 已投票 → 顯示「已投票」
      ↓
點擊投票按鈕
      ↓
打開投票對話框
      ↓
員工選擇選項
      ↓
提交投票: POST /api/votes/submit
      ↓
後端檢查重複投票
      ↓
❌ 已投票 → 返回錯誤
❌ 時間範圍外 → 返回錯誤
✓ 驗證通過
      ↓
插入 VoteRecords 表
      ↓
更新 VoteOptions.voteCount
      ↓
插入 VoteParticipants 表 (防重複)
      ↓
插入 VoteLogs 表 (SUBMIT)
      ↓
前端顯示成功提示
      ↓
刷新投票狀態
```

### 3. 投票結果查詢流程
```
用戶點擊「查看結果」
      ↓
調用 API: GET /api/votes/:voteId/results
      ↓
後端查詢 VoteOptions (投票計數)
      ↓
後端查詢 VoteParticipants (參與人數)
      ↓
後端查詢 VoteRecords (總投票數)
      ↓
計算百分比和統計信息
      ↓
根據 allowAnonymous 決定是否返回投票者清單
      ↓
返回結果 JSON
      ↓
前端渲染結果圖表和統計
```

## 防重複投票的多層防護

### 層級 1：資料庫級別
```sql
UNIQUE(voteId, userId) 在 VoteParticipants 表上
→ 違反約束會拋出異常
```

### 層級 2：應用邏輯檢查
```javascript
// 投票前檢查
SELECT COUNT(*) FROM VoteRecords 
WHERE voteId = @voteId AND userId = @userId

// 結果 > 0 → 返回 400 錯誤 "User has already voted"
```

### 層級 3：前端 UI 反饋
```javascript
// 載入投票時檢查
GET /api/votes/:voteId/check-voted?userId=xxx
// 返回 { hasVoted: true/false }

// hasVoted = true → 禁用投票按鈕，顯示「已投票」
```

## 記名投票 vs 不記名投票

### 記名投票 (allowAnonymous = false)
```
VoteRecords.userId = "emp_001"  ✓ 記錄用戶 ID
VoteParticipants.userId = "emp_001"  ✓ 記錄參與者

前端可查看：
  ✓ 投票者名單
  ✓ 誰投了哪個選項
  ✓ 投票時間
```

### 不記名投票 (allowAnonymous = true)
```
VoteRecords.userId = NULL  ✗ 不記錄用戶 ID
VoteParticipants.userId = "emp_001"  ✓ 記錄參與者（防重複）

前端可查看：
  ✗ 投票者名單
  ✓ 選項統計
  ✓ 參與人數
```

## 狀態流轉

```
                    ┌─────────────────┐
                    │     Draft       │
                    │   (草稿)        │
                    └────────┬────────┘
                             │
                        [啟動]↓
                    ┌─────────────────┐
                    │    Active       │
                    │   (進行中)      │
                    └────────┬────────┘
                    ┌────────┴─────────┐
              [投票結束]↓              ↓[取消]
        ┌─────────────────┐   ┌─────────────────┐
        │     Closed      │   │    Cancelled    │
        │    (已結束)     │   │    (已取消)     │
        └─────────────────┘   └─────────────────┘
```

## 性能優化

### 索引策略
- `IX_Votes_Status` - 按狀態篩選投票
- `IX_VoteParticipants_UserId` - 快速查詢用戶投票記錄
- `IX_VoteRecords_VoteId` - 快速計算投票統計

### 查詢優化
- 使用視圖進行複雜統計
- 在應用層快取投票列表
- 分頁查詢大數據集

## 安全考慮

1. **防重複投票** ✓
   - 資料庫約束
   - 應用層檢查
   - 前端 UI 防護

2. **資料隱私** ✓
   - 不記名投票不暴露用戶身份
   - 系統日誌記錄所有操作

3. **一致性** ✓
   - 事務支援（重要操作應包裹在事務中）
   - UNIQUE 約束防止數據異常

4. **可審計性** ✓
   - VoteLogs 表記錄所有操作
   - 時間戳記錄

## 擴展點

1. **權限系統**
   - 添加 UsersTable 和 Roles
   - 在 API 中檢查用戶權限

2. **通知系統**
   - 投票開始通知
   - 投票結束提醒
   - 郵件發送

3. **高級分析**
   - 投票趨勢分析
   - 用戶行為分析
   - 預測性分析

4. **多租戶支援**
   - 添加 TenantId 欄位
   - 資料隔離
